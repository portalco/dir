# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

{{- if .Values.externalSecrets.enabled }}
---
# ExternalSecret for DIR API server credentials
#
# This syncs all sensitive credentials from HashiCorp Vault to a Kubernetes Secret.
# The External Secrets Operator (ESO) manages the sync automatically.
#
# What it creates:
# - Kubernetes Secret: {{ include "chart.fullname" . }}
# - Contains all credentials: node identity, OCI auth, sync auth
#
# Prerequisites:
# 1. Credentials stored in Vault at configured path
# 2. ClusterSecretStore configured (referenced below)
# 3. ESO has permissions to read from Vault path
#
# Lifecycle:
# - ESO syncs from Vault every refresh interval (default: 1h)
# - Secret is automatically updated if Vault values change
# - Secret is automatically recreated if deleted
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "chart.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "chart.labels" . | nindent 4 }}
    app.kubernetes.io/component: secrets
spec:
  # Refresh interval - how often to sync from Vault
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  
  # Reference to the ClusterSecretStore
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStore }}
    kind: {{ .Values.externalSecrets.secretStoreKind | default "ClusterSecretStore" }}
  
  # Target Kubernetes Secret to create/update
  target:
    name: {{ include "chart.fullname" . }}
    creationPolicy: Owner  # ESO owns this secret (will recreate if deleted)
    deletionPolicy: Retain # Keep secret even if ExternalSecret is deleted
  
  # Data to sync from Vault
  data:
    {{- if .Values.externalSecrets.nodeIdentity.enabled }}
    # Node identity private key for stable P2P peer ID
    - secretKey: node.privkey
      remoteRef:
        key: {{ .Values.externalSecrets.vaultPath }}
        property: {{ .Values.externalSecrets.nodeIdentity.property | default "node.privkey" }}
        conversionStrategy: Default
        decodingStrategy: None
    {{- end }}
    
    {{- if .Values.externalSecrets.ociAuth.enabled }}
    # OCI registry authentication (for storing/retrieving agent records)
    - secretKey: oci-username
      remoteRef:
        key: {{ .Values.externalSecrets.vaultPath }}
        property: {{ .Values.externalSecrets.ociAuth.usernameProperty | default "oci-username" }}
        conversionStrategy: Default
        decodingStrategy: None
    - secretKey: oci-password
      remoteRef:
        key: {{ .Values.externalSecrets.vaultPath }}
        property: {{ .Values.externalSecrets.ociAuth.passwordProperty | default "oci-password" }}
        conversionStrategy: Default
        decodingStrategy: None
    {{- end }}
    
    {{- if .Values.externalSecrets.syncAuth.enabled }}
    # Sync authentication (shared with remote nodes for P2P sync)
    - secretKey: sync-username
      remoteRef:
        key: {{ .Values.externalSecrets.vaultPath }}
        property: {{ .Values.externalSecrets.syncAuth.usernameProperty | default "sync-username" }}
        conversionStrategy: Default
        decodingStrategy: None
    - secretKey: sync-password
      remoteRef:
        key: {{ .Values.externalSecrets.vaultPath }}
        property: {{ .Values.externalSecrets.syncAuth.passwordProperty | default "sync-password" }}
        conversionStrategy: Default
        decodingStrategy: None
    {{- end }}
{{- end }}

